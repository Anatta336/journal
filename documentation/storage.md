# Storage

This document describes how journal entries are stored on the backend server.

## Directory Structure

```
data/
  entries/
    <uuid>.md           # Active entries
    .trash/
      <uuid>.md         # Soft-deleted entries
```

When `TESTING=true` or `NODE_ENV=test` is set, the backend uses `data-test/entries/` instead for test isolation.

## File Format

Each entry is stored as a Markdown file with YAML frontmatter:

```markdown
---
creationDate: '2025-01-15T10:30:00.000Z'
lastUpdated: '2025-01-15T14:22:00.000Z'
hash: a1b2c3d4e5f6...
tags:
  - example
---

Entry content in Markdown format...
```

See [Frontmatter](frontmatter.md) for details on the metadata fields.

## File Naming

Files are named with a UUID v4 and `.md` extension:
```
59127f5c-cd5e-4a5b-9ae3-67493aaf4d19.md
```

The UUID is generated by the backend when creating a new entry.

## Soft Delete (Trash)

When an entry is deleted:
1. The file is moved from `data/entries/` to `data/entries/.trash/`
2. The file retains its original name
3. No API exists to restore trashed entries - recovery is manual

This approach allows accidental deletions to be recovered by manually moving files back.

## Directory Initialization

The backend automatically creates the `data/entries/` and `data/entries/.trash/` directories on startup if they don't exist.

## Handling Existing Files

Any `.md` file in the entries directory is treated as an entry:
- Files with valid YAML frontmatter are parsed normally
- Files missing `creationDate` get it populated from the file system creation time
- Files with invalid/malformed frontmatter are skipped when listing

## Concurrency

The current implementation assumes sequential access. The code includes comments indicating where file locking should be added if concurrent access is needed in the future.

## API Endpoints

### Entry CRUD

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/entries` | GET | List all entries (metadata + preview) |
| `/api/entries` | POST | Create new entry |
| `/api/entries/:id` | GET | Get single entry |
| `/api/entries/:id` | PUT | Update entry |
| `/api/entries/:id` | DELETE | Soft-delete entry (move to trash) |

### Sync Endpoints

See [Sync](sync.md) for the synchronization API.

## Implementation

The storage service is implemented in [backend/src/services/storage.ts](../backend/src/services/storage.ts).

Key functions:
- `getAllEntries()` - List entries sorted by creation date (newest first)
- `getEntry(id)` - Read single entry
- `createEntry(content, tags)` - Create with generated UUID
- `updateEntry(id, content, tags)` - Update existing entry
- `deleteEntry(id)` - Move to trash
- `getManifest()` - Get entry hashes for sync
- `calculateGlobalHash()` - Calculate collection hash
